name: Tests

on:
    push:
        branches: [main, master]
    pull_request:
        branches: [main, master]

jobs:
    test:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Set up Python
              uses: actions/setup-python@v5
              with:
                  python-version: "3.13"

            - name: Install dependencies
              run: |
                  python -m pip install --upgrade pip
                  pip install -r requirements-test.txt

            - name: Run tests with coverage
              run: |
                  pytest tests/ -v --cov=custom_components/parmair --cov=tools --cov-report=xml --cov-report=term-missing

            - name: Upload coverage reports
              uses: codecov/codecov-action@v4
              with:
                  files: ./coverage.xml
                  fail_ci_if_error: false
              continue-on-error: true

    lint:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Set up Python
              uses: actions/setup-python@v5
              with:
                  python-version: "3.13"

            - name: Install dependencies
              run: |
                  python -m pip install --upgrade pip
                  pip install -r requirements-test.txt

            - name: Run Ruff linter
              run: |
                  ruff check custom_components/ tools/ tests/
              continue-on-error: true

            - name: Run Ruff formatter check
              run: |
                  ruff format --check custom_components/ tools/ tests/
              continue-on-error: true
